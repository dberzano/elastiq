#!/bin/bash

#
# alice/local.conf -- by Dario Berzano <dario.berzano@cern.ch>
#
# Part of virtual-analysis-facility.
#
# System configuration for using VAF in ALICE.
#

# PoD location
export VafConf_RemotePodLocation='/cvmfs/sft.cern.ch/lcg/external/PoD/3.12/x86_64-slc5-gcc41-python24-boost1.53'

if [ "$UseCvmfsLocally" == 1 ] ; then

  # Snapshot LD_LIBRARY_PATH
  Saved_LD_LIBRARY_PATH="$LD_LIBRARY_PATH"

  # Avoid conflicts with default MODULES* in uCernVM
  unset MODULEPATH
  unset MODULESHOME

  # ALICE environment: set AliRoot and dependencies
  source /cvmfs/alice.cern.ch/etc/login.sh
  source `which alienv` setenv VO_ALICE@AliRoot::$VafAliRootVersion

  # Restore snapshotted environment and remove unwanted paths
  export LD_LIBRARY_PATH=$(
    IFS=':'
    NewLibPath=''
    for P in $LD_LIBRARY_PATH ; do
      if [ ! -e "$P/libstdc++.so" ] ; then
        NewLibPath="$NewLibPath:$P"
      fi
    done
    echo "${NewLibPath:1}"
  ):"$Saved_LD_LIBRARY_PATH"
  unset Saved_LD_LIBRARY_PATH

  # Configure local environment using software from CernVM-FS (currently works
  # only with Linux x86_64, like a CernVM Desktop machine)
  export LD_LIBRARY_PATH="/cvmfs/sft.cern.ch/lcg/external/Boost/1.53.0_python2.4/x86_64-slc5-gcc41-opt/lib:$LD_LIBRARY_PATH"
  export VafConf_LocalPodLocation="$VafConf_RemotePodLocation"

else
  # Configure local environment using custom builds
  source "$AliceEnv" -n -q
fi

# Create proxy and token if necessary
if ! xrdgsiproxy info > /dev/null 2>&1 || \
   ! alien-token-info > /dev/null 2>&1 ; then
  alien-token-destroy
  xrdgsiproxy destroy
  alien-token-init
fi
